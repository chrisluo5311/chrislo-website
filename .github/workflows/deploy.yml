name: Push-to-EC2

# Trigger deployment only on push to main branch
on:
  push:
    branches:
      - master
  # 允許手動觸發（當遠端資料夾被清掉或想重跑時很方便）
  workflow_dispatch:

# 連續 push 多次，只會留下最新那次部署在跑，舊的會被自動取消。
concurrency:
  group: deploy-production
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to EC2 on master branch push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the files
        uses: actions/checkout@v4
        with:
          lfs: true  # Ensure Git LFS files are fetched
          fetch-depth: 0  # Fetch all history for all branches and tags
      
      - name: Git LFS Pull
        run: |
          git lfs install
          git lfs pull
      
      # 防呆：如果把 pointer 誤 commit 進來，直接讓 CI fail
      - name: Fail build if any LFS pointer appears in repo
        run: |
          if grep -R --include="*.{png,svg,jpg,jpeg,gif,webp}" -n "version https://git-lfs.github.com/spec/v1" . ; then
            echo "ERROR: Found LFS pointer file(s). Real binary not present."
            exit 1
          fi
          
      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci --no-audit --no-fund --progress=false

      - name: Build
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: npx vue-cli-service build --report --report-json
      
      # --- Deploy to EC2 ---
      - name: Prepare target dirs on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            mkdir -p ~/upload_tmp/dist
            mkdir -p ${{ secrets.TARGET_DIR }}/dist
      
      - name: Upload dist to EC2 (to tmp)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "dist/**"
          target: "/home/${{ secrets.USERNAME }}/upload_tmp/dist"
          strip_components: 1
          overwrite: true
          debug: true
      
      - name: Sync to web root
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            if [ -w "${{ secrets.TARGET_DIR }}/dist" ]; then
              rsync -a --delete ~/upload_tmp/dist/ ${{ secrets.TARGET_DIR }}/dist/
            else
              sudo rsync -a --delete ~/upload_tmp/dist/ ${{ secrets.TARGET_DIR }}/dist/
            fi

      - name: Ensure serve is installed on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            if ! command -v serve >/dev/null 2>&1; then
              echo "serve not found. Installing globally..."
              sudo npm i -g serve
            else
              echo "serve is already installed."
            fi

      - name: Ensure PM2 is installed on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "pm2 not found. Installing globally..."
              sudo npm i -g pm2
            else
              echo "pm2 is already installed."
            fi
      
      - name: Restart PM2 (serve static on :8080)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 10m
          script: |
            # 以 inline 指令啟動，不再依賴 ecosystem.config.js 存在
            # 若已存在同名 process，先刪除再重啟
            pm2 delete chrislo-web || true
            pm2 start "serve -s ${{ secrets.TARGET_DIR }}/dist -l tcp://127.0.0.1:8080" --name chrislo-web
            pm2 save